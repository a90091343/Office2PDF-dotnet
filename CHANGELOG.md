# Changelog

All notable changes to Office2PDF will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [5.1.5] - 2025-10-03

### 新增功能

- **🌐 网络路径支持** - 完整支持UNC网络路径（`\\server\share`格式）的文件转换
  - 自动检测并处理网络路径文件
  - 使用临时本地副本进行转换，确保COM组件兼容性
  - 支持网络路径输入和输出
  - 自动清理临时文件，无残留
  - 适用于Word、Excel、PPT的MS Office和WPS引擎

- **🎯 拖拽文件夹到EXE启动** - 支持将文件夹拖拽到程序图标上快速启动
  - 自动填充来源文件夹路径
  - 自动生成目标文件夹路径（`来源路径_PDFs`）
  - 提升批量转换工作流效率

- **📊 WPS Excel隐藏工作表跳过** - WPS引擎转换Excel时自动跳过隐藏的Sheet
  - 避免转换用户不需要的隐藏内容
  - 减少不必要的PDF文件生成
  - 提升转换效率

### 改进优化

- **🏗️ 重大架构重构** - 代码结构优化，提升可维护性
  - 新增 `ConversionEngine.cs` - 独立的转换引擎类（1689行），负责所有PDF转换业务逻辑
  - 新增 `MainWindowViewModel.cs` - MVVM模式的视图模型类（372行），管理UI状态和数据绑定
  - 新增 `OfficeApplication.cs` - 统一的Office引擎接口和工具类（699行）
  - 新增 `NetworkPathHelper.cs` - 网络路径处理工具类和装饰器（353行）
  - 删除 `WordApplication.cs` - 功能整合到新架构中
  - `MainWindow.xaml.cs` 从1608行精简到657行（减少60%），仅负责UI交互
  - 职责分离清晰：UI层、业务逻辑层、数据访问层独立
  - 提升代码可测试性和可扩展性

- **🌐 网络路径处理重构** - 使用装饰器模式重构网络路径处理逻辑
  - 创建 `NetworkPathHandlingDecorator` 装饰器类，透明处理所有网络路径操作
  - 采用**目录级映射策略**（而非文件级），完美支持 Excel 多 sheet 输出场景
  - 从所有 6 个应用类中移除网络路径处理代码，**消除 200+ 行重复代码**
  - 所有应用类（MSWord, MSExcel, MSPPT, WpsWriter, WpsSheet, WpsPPT）完全不知道网络路径的存在
  - 修复 MSWordApplication 输出网络路径缺失的问题
  - 修复 WpsWriterApplication 完全缺失网络路径支持的问题
  - 在 ConversionEngine 中统一包装装饰器，对所有应用类自动生效
  - 符合**单一职责原则**和**开闭原则**，代码更优雅、易维护

- **💡 引擎选择帮助** - 新增引擎选择区域的"?"帮助按钮
  - 弹出式帮助面板解释自动选择、MS Office、WPS三种引擎模式
  - 详细说明自动选择模式的工作原理和回退机制
  - 提示WPS模式可避免MS Office进程残留问题
  - 提升用户理解，减少配置困惑

- **🎨 UI细节优化** - 改善界面交互体验
  - 引擎选择区域文案从"MS Office"改为"自动选择"
  - 引擎选择区域文案从"WPS Office"简化为"WPS"
  - Word批注选项文案从"打印注释"改为"打印批注与修订标记"（更准确）
  - 删除原文件选项调整为左对齐
  - 关于按钮右侧边距调整（从10调整到30）

- **�📝 WPS批注处理增强** - 批注删除失败时输出友好警告信息
  - 明确提示用户PDF可能保留批注
  - 不再是静默处理，提升透明度
  - 帮助用户理解转换结果

- **🛠️ COM清理规范** - 所有COM对象释放异常处理标准化
  - 添加明确注释：`/* COM清理失败不影响程序继续 */`
  - 提升代码可读性和维护性

- **🔧 开发环境升级** - 项目配置现代化
  - ToolsVersion升级到 `Current`（从15.0）
  - TargetFramework降级到 .NET 4.7（提升兼容性，从.NET 4.8）
  - App.config同步更新运行时配置

### 问题修复

- **🐛 Excel网络路径兼容性** - 解决Excel COM组件无法直接处理UNC网络路径的问题
  - 临时本地副本方案确保稳定性
  - 自动复制到最终网络位置
  - 避免"文件未找到"或"路径无效"错误

- **🐛 多文件冲突智能识别** - 修复同名但不同扩展名文件的转换冲突
  - 例如：`1.doc` 和 `1.ppt` 同时存在时
  - 自动保留完整扩展名：`1.doc.pdf`、`1.ppt.pdf`
  - 输出友好警告信息，提示文件名冲突数量

### 技术细节

**网络路径处理机制：**

- 使用MD5哈希生成唯一临时文件名，避免冲突
- 临时文件存储在 `%TEMP%\Office2PDF_NetworkTemp\` 目录
- 转换完成后自动复制到网络位置并清理临时文件
- 程序退出时清理所有残留临时文件

**架构优化：**

- **MVVM模式**：清晰的视图-视图模型-模型分离
- **单一职责**：每个类专注于特定功能
- **依赖注入**：通过构造函数注入依赖，便于测试
- **线程安全**：使用ConcurrentDictionary管理状态
- **取消令牌**：支持异步操作的优雅取消

## [5.1.1] - 2025-09-23

### 问题修复

- **彻底解决WPS文字转PDF批注控制问题** - 🎉 实现全新的文档预处理解决方案

#### 🔥 核心实现逻辑

**勾选"打印批注与修订标记"** (`IsPrintRevisions = true`)

- 直接导出原始文档，显示所有批注和修订标记
- 调用：`_document.ExportAsFixedFormat(toFilePath, 17)`

**不勾选"打印批注与修订标记"** (`IsPrintRevisions = false`)

- 实施预处理流程：
  1. 创建临时文档副本 (`SaveAs2()`)
  2. **物理删除所有批注**：

     ```csharp
     var comments = tempDoc.Comments;
     while (comments.Count > 0) {
         comments.Item(1).Delete();
     }
     ```

  3. **接受所有修订标记**：

     ```csharp
     var revisions = tempDoc.Revisions;
     if (revisions.Count > 0) {
         revisions.AcceptAll();
     }
     ```

  4. 导出预处理后的"干净"文档
  5. 自动清理临时文件

#### 🛠️ 核心技术特性

- **彻底解决WPS粘滞问题** - 不再依赖WPS的显示设置API，物理删除内容让WPS无法显示不存在的批注
- **完全保护原文档** - 所有操作在临时副本中进行，原始文档完全不受影响  
- **健壮的错误处理** - 批注删除失败时继续处理修订，临时文件清理有多重保障，COM对象释放安全处理
- **高兼容性** - 支持各种复杂的批注和修订场景，不依赖WPS版本特定的API

#### 📋 解决方案优势

✅ **彻底解决** - 物理删除批注和修订，解决WPS API粘滞现象  
✅ **不影响原文档** - 操作临时副本，100%安全  
✅ **兼容性好** - 不依赖WPS特定的显示设置，通用性强  
✅ **自动清理** - 临时文件管理完善，无残留  
✅ **向后兼容** - 保持原有的`IsPrintRevisions`配置接口

现在用户只需要：

- **勾选"打印批注与修订标记"** - PDF中包含所有批注和修订
- **不勾选"打印批注与修订标记"** - PDF中完全没有批注和修订

无论WPS图形界面之前做过什么操作，都不会影响程序的转换结果！

## [5.1.0] - 2025-08-30

**贡献者**: azhan (感谢 GitHub Copilot 协助)

### 新增功能

- **转换结果汇总功能** - 显示总文件数、成功数、失败数的详细统计
- **失败文件列表** - 完整列出所有转换失败的文件路径，便于问题定位
- **成功提示** - 全部转换成功时显示祝贺信息
- **撤回功能增强** - 支持一键撤回所有更改，恢复原始状态
- **增强的构建脚本** - 支持Visual Studio 2025及更全面的VS版本检测
- **智能路径处理** - 自动去除复制路径中的首尾引号，提升粘贴体验
- **自动目标生成** - 设置来源路径时自动生成目标路径（`来源路径_PDFs`）
- **增强路径验证** - 改进目标路径验证逻辑，支持无效路径的早期检测和友好提示

### 问题修复

- **文件计数修复** - 转换进度显示从第1个文件开始计数，符合人类习惯（之前从0开始）
- **目标路径同步** - 修复拖拽更换来源文件夹时目标路径不自动更新的问题
- **撤回逻辑修复** - 修复第一次转换时撤回功能无法正确恢复PDF文件的问题
- **撤回功能重大修复** - 修复第一次转换时撤回功能逻辑错误的问题
- **按钮状态修复** - 修复路径验证过于严格导致按钮无法启用的问题
- **构建配置优化** - 移除冗余的TargetFrameworkVersion参数，使用项目文件配置
- **编译警告清理** - 清理未使用变量和调试代码

### 改进优化

- **用户体验** - 更清晰的转换结果反馈，包含emoji图标增强可读性
- **路径处理** - 自动去除复制路径中的引号，提升粘贴体验
- **自动路径生成** - 设置来源路径时自动生成目标路径（`来源路径_PDFs`）
- **按钮样式** - 优化"开始"按钮的大小和字体，提升视觉效果
- **错误处理** - 更详细的编译错误提示和故障排除建议

### 界面优化

- **UI布局优化** - 重新设计按钮布局，开始按钮居中且更宽，撤回按钮右对齐
- **视觉效果增强** - 优化开始按钮字体大小和粗细，提升视觉效果  
- **项目结构清理** - 删除无用文件，整理代码结构，为发布做准备
- **文档架构重构** - 分离README和CHANGELOG职责，提升文档专业性
- **代码质量** - 清理了冗余的版本支持注释，提高代码可维护性

## [5.0.0] - 2025-08-24

**贡献者**: azhan (感谢 GitHub Copilot 协助)  
**WPS 转换思路来源**: iOS-执著 ([WPSToPDF](https://gitee.com/BudStudio/WPSToPDF))

### 新增功能

- **WPS Office 引擎支持** - 完整支持 WPS 文字、WPS 表格、WPS 演示的批量转换
- **双引擎切换** - 新增"引擎"单选项（MS Office / WPS Office），默认选择 WPS
- **Word 批注选项** - 新增"打印注释"选项，可控制是否包含修订批注
- **Excel Sheet 分离** - 新增"一个 Sheet 一个 PDF"模式，可按 Sheet 拆分输出多个 PDF
- **原文件删除** - 新增"删除原文件"选项，带确认弹窗 + 多次重试 + 进程清理
- **转换控制** - 转换按钮支持"开始/结束"切换，实现任务取消功能
- **环境检测增强** - WPS 环境检测使用正确 ProgID（KWps/KET/KWPP），避免误判

### 改进优化

- **界面优化** - 默认取消勾选 Excel，避免误触大批量表格转换
- **窗口布局** - 压缩窗口高度与布局，移除底部多余空白，界面更紧凑
- **日志系统** - 日志输出新增颜色区分（Info/Warning/Error），附带时间戳与阶段分隔
- **拖拽体验** - 拖拽区域提示文案清晰化，空路径时灰底提示
- **作者信息** - 更新作者信息，移除旧二维码弹出层，界面更简洁

### 问题修复

- **COM 对象管理** - 全面梳理 MS Office 与 WPS 的 COM 生命周期管理
- **资源释放** - 文档/工作簿/演示文稿/Sheet 均显式关闭与释放
- **进程清理** - WPS Excel 每个 Sheet 导出后显式释放 COM 对象，减少内存占用
- **取消操作** - 安全的取消操作状态回收（按钮文字、令牌释放、列表清理）
- **删除重试** - 删除原文件逻辑包含渐进重试（属性重置、GC、进程清理）

### 技术实现

- **接口抽象** - 抽象 IOfficeApplication 接口 + 泛型 ConvertToPDF 方法
- **代码复用** - 统一三套文档类型的实现逻辑
- **参数绑定** - 按文档类型动态绑定参数（批注/Sheet拆分）
- **日志统一** - 日志统一入口 AppendLog + 级别枚举
- **属性联动** - ViewModel 属性变更链条更清晰，避免重复刷新

## [3.0.0] - 2025-05-29

**贡献者**: evgo2017

### 新增功能

- 基于 .NET Framework 重构的全新版本
- 图形用户界面 (GUI)
- 批量转换功能
- 子文件夹递归处理
- 文件类型选择（Word/Excel/PPT）

### 技术实现

- 使用 WPF 框架构建用户界面
- COM 组件交互处理 Office 文档
- 完整的错误处理和日志系统

## [2.0.0] - 2020-08-26

**贡献者**: evgo2017

### 新增功能

- GUI 界面
- 文件类型选择功能
- 子文件夹处理选项

## [1.0.0] - 2018-11-02

**贡献者**: evgo2017

### 新增功能

- 基础的 Office 文档转 PDF 功能
- 命令行界面
- Word、Excel、PowerPoint 支持

---

## 版本号规则

### 功能更新记录 (记录在README.md中)

- **Major版本 (X.0.0)** - 重大功能变更、架构重构、破坏性更新
- **Minor版本 (X.Y.0)** - 新功能添加、重要特性增强

### 内部修复记录 (仅记录在CHANGELOG.md中)

- **Patch版本 (X.Y.Z)** - Bug修复、性能优化、小幅改进、文档更新
- **构建系统更新** - 编译脚本改进、依赖更新
- **代码质量改进** - 重构、注释优化、警告修复

### 更新策略

- 只有**功能更新**（Major/Minor）才会更新README.md的版本历史
- 所有变更都会记录在CHANGELOG.md中
- 遵循语义化版本规范 (Semantic Versioning)
